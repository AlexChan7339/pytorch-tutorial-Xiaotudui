# 17-卷积操作

> 卷积相当于一个饼, 盖在上面,做运算

![image-20251026171554706](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100049.png)

- 1d: 1维卷积神经网络
- 2d: 2维卷积神经网络（比如图像），主要对2d进行讲解



**torch.nn** VS **torch.nn.functional**

- troch.nn是对 torch.functional的封装，更加利于我们使用
- torch.nn.functional使用起来更麻烦,里面的函数跟torch.nn是对应的关系

![image-20251026172147569](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100813.png)

来看torch.nn.functional下的conv2d

![image-20251026172233327](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100790.png)

- input：输入，格式为（minibatch， 通道数，长，宽）
- weight：权重，可以看成卷积核，格式为（ 输出通道数，其他计算【groups一般取为1， group是分组卷积，对不同的通道使用不同的卷积核】，长，宽）
- bias：偏置
- stride：步进
- padding:在图像的左右两边进行填充，取值可以为一个数或者元组【长，宽】，默认值为0（不进行填充）



![image-20251026172551510](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100684.png)

- 左边是5*5大小的图像，每个数字代表在该个像素中颜色显示

- 卷积核：3*3大小的

- 卷积过程：先将卷积核与图像左上角进行匹配，对应位置相乘再最后求和，该位置的结果是$1*1+2*2+0*1+0*0+1*1+2*0+1*2+2*1+1*0=10$，将其进行输出

  ![image-20251026172725204](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100619.png)

  - 接下里需要将卷积核向右整体移动一格（sride=1）,该位置的结果是$2*1+0*2+3*1+1*0+2*1+3*0+2*2+1*1+1*0=12$,将12进行输出

    ![image-20251026172950138](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100641.png)

  - 接下里需要将卷积核向右整体移动一格（sride=1）,该位置的结果是$0*1+3*2+1*1+2*0+3*1+1*0+1*2+0*1+0*0=12$,将12进行输出

    ![image-20251026173121336](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100182.png)

  此时与图像右边缘重合，右边无法移动，此时需要向下换一行从左边还是进行匹配

  > ![image-20251026173510342](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100176.png)
  >
  > - sH：控制横向的步进（默认为1）
  > - sW：控制纵向的步进（默认为1）

  - 该位置的结果是$0*1+1*2+2*1+1*0+2*1+1*0+5*2+2*1+3*0=18$

    ![image-20251026173646307](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100246.png)

  - 继续向右滑动一块，该位置的结果$1*1+2*2+3*1+2*0+1*1+0*0+2*2+3*1+1*0=16$

    ![image-20251026173848879](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100366.png)

  - 继续向右滑动一块，该位置的结果$2*1+3*2+1*1+1*0+0*1+0*0+3*2+1*1+1*0=16$

    ![image-20251026173919833](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100400.png)

  - 此时与图像右边缘重合，右边无法移动，此时需要向下换一行从左边还是进行匹配

  - 该位置的结果$1*1+2*2+1*1+5*0+2*1+3*0+2*2+1*1+1*0=13$

    ![image-20251026174014134](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100623.png)

  - 继续向右滑动一块，该位置的结果$2*1+1*2+0*1+2*0+3*1+1*0+1*2+0*1+1*0=9$

    ![image-20251026174130530](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100658.png)

  - 继续向右滑动一块，该位置的结果$1*1+0*2+0*1+3*0+1*1+1*0+0*2+1*1+1*0=3$

    ![image-20251026174235360](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100691.png)

  - 卷积后的输出结果（stride=1）

    ![image-20251026180222915](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100733.png)

    > 当stride=2时，输出为2*2的矩阵

```python
# 验证上面的推导是否准确
import torch
import torch.nn.functional as F

input = torch.tensor([[1, 2, 0, 3, 1],
                     [0, 1, 2, 3, 1],
                     [1, 2, 1, 0, 0],
                     [5, 2, 3, 1, 1],
                     [2, 1,0, 1, 1]])# 两个中括号表示2为矩阵
# 卷积核
kernel = torch.tensor([[1, 2, 1],
                     [0, 1, 1],
                     [2, 1, 0]])
print(input.shape)
# torch.Size([5, 5])
# size值不满足说明文档中输入格式：（minibatch，in_channels,iH, iW）
print(kernel.shape)
# torch.Size([3, 3])
# size值不满足说明文档中输出格式：（out_channels，in_channels/groups,kH, kW）
# 需要对其进行转换
input = torch.reshape(input, (1, 1, 5, 5))
"""
第一个1：batchsize=1
第二个1：通道为1
（5，5） ：（长，宽）
"""
kernel = torch.reshape(kernel, (1, 1, 3, 3))
print(input.shape)
# torch.Size([1, 1, 5, 5])
print(kernel.shape)
# torch.Size([1, 1, 3, 3])

output = F.conv2d(input, kernel, stride=1)
print(output)
# 与前面推导结果一致，每一行&每一列相当于移动2次，加上初始位置，所以形状为torch.Size([1, 1, 3, 3])
```

![image-20251101201746279](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100924.png)

​	

```python
output2 = F.conv2d(input, kernel, stride=2)
print(output2)
# 每一行&每一列相当于移动3次，加上初始位置，所以形状为torch.Size([1, 1, 2, 2])
```

![image-20251026180404541](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100842.png)

**padding=1**

相当于原图像上下左右边缘均增加一行/一列，填充值默认为0；

![image-20251026180759719](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100033.png)

卷积过程卷积核从填充后的左上角进行匹配

![image-20251026180812276](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100118.png)

```python
output3 = F.conv2d(input, kernel, stride=1, padding=1)
print(output3)

```

![image-20251101201841199](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100176.png)

明显输出尺寸变大了，验证下，第一个格子的计算结果只有中间的$1*1=1$

![image-20251026181031977](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062100225.png)
