# 18-卷积层

![image-20251026195623374](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062101664.png)

- in_channels:输入通道数（需要设置，常用）
- out_channels:输出通道数（需要设置，常用）
- kernel_size:卷积核大小，取值可以为int或者tuple类型【不规则形状，比如（1， 2）】（需要设置，常用）
- stride:卷积过程的步进（有默认取值为1，常用）
- padding：对原图像外围要补充几层（有默认取值0，常用）
- dilation：卷积核中元素的距离，不常用（有默认取值）
  - 具体可以看https://github.com/vdumoulin/conv_arithmetic/blob/master/README.md的gif动画展示
- groups:一般为1，如果不为1则代表分组卷积（几乎遇不到）（有默认参数）
- bias：是否需要偏置（有默认参数）
- padding_mode:padding区域填充模式（有默认参数）

![image-20251026200202008](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062101626.png)

解析in_channels & out_channels

如果in_channels=1 且只有1个卷积核，那么out_channel=1

![image-20251026201123872](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062101248.png)

如果in_channels=1 且有2个卷积核，那么out_channel=2。许多算法都是不算增加卷积数来提升算法效果

![image-20251026201436576](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062101340.png)

> 卷积结果不是卷积的结果

在pycahrm项目中新建python文件nn_conv2d

```python
import torch
import torchvision
from torch.utils.data import DataLoader
from torch import nn
from torch.nn import Conv2d
from torch.utils.tensorboard import SummaryWriter

dataset = torchvision.datasets.CIFAR10("./dataset/CIFAR10", train=False, transform=torchvision.transforms.ToTensor(), download=True)

dataloader = DataLoader(dataset, batch_size=64)

class Tudui(nn.Module):
    def __init__(self):
        super(Tudui, self).__init__()
        self.conv1 = Conv2d(in_channels=3, out_channels=6, kernel_size=3, stride=1, padding=0)
        # first 3:输入为彩色图像（3通道）
        # 6：out_channel size
        # second 3： kernel size
    def forward(self, x):
        x = self.conv1(x)
        return x
tudui = Tudui()
print(tudui)
# 查看网络结构
"""
Tudui(
(conv1):ConV2d(3, 6, kernel(3, 3), stride(1, 1))
)
"""   
# 会将kernel_size=3 拆解为（3， 3）
# 会将stride=1 拆解为（1， 1）

# 用tensorboard进行可视化 
writer = SummaryWriter("../logs")
step = 0
for data in dataloader:
    imgs, targets = data
    output = tudui(imgs)
    print(imgs.shape)
    # tensor.Size([64, 3, 32, 32])
    # 对应卷积神经网络的输入数据格式：（minibatch，in_channels,iH, iW）
    print(output.shape)
    # tensor.Size([64, 6, 30, 30]), 这里设置的batch_size=64
    # 由于卷积核是（3， 3）, 所以卷积后的尺寸变为（30，30 ）
    writer.add_images("input", imgs, step)
    writer.add_images("output", output, step)
    step = step + 1 
    
    # 会报错：因为输出图像是6个channel， 但是彩色图像只能显示3个channel,需要对代码进行修改
```

```python
import torch
import torchvision
from torch.utils.data import DataLoader
from torch import nn
from torch.nn import Conv2d
from torch.utils.tensorboard import SummaryWriter

dataset = torchvision.datasets.CIFAR10("./dataset/CIFAR10", train=False, transform=torchvision.transforms.ToTensor(), download=True)

dataloader = DataLoader(dataset, batch_size=64)

class Tudui(nn.Module):
    def __init__(self):
        super(Tudui, self).__init__()
        self.conv1 = Conv2d(in_channels=3, out_channels=6, kernel_size=3, stride=1, padding=0)
        # first 3:输入为彩色图像（3通道）
        # 6：out_channel size
        # second 3： kernel size
    def forward(self, x):
        x = self.conv1(x)
        return x
tudui = Tudui()
print(tudui)
# 查看网络结构
"""
Tudui(
(conv1):ConV2d(3, 6, kernel(3, 3), stride(1, 1))
)
"""   
# 会将kernle=1 拆解为（3， 3）
# 会将stride=1 拆解为（1， 1）

# 用tensorboard进行可视化 
writer = SummaryWriter("../logs")
step = 0
for data in dataloader:
    imgs, targets = data
    output = tudui(imgs)
    print(imgs.shape)
    # tensor.Size([64, 3, 32, 32])
    # 对应卷积神经网络的输入数据格式：（minibatch，in_channels,iH, iW）
    print(output.shape)
    # tensor.Size([64, 6, 30, 30]), 这里设置的batch_size=64
    # 目的是提取输入的更多特征。刚开始输入是RGB三个channels，经过6个卷积核之后就提取出了6个特征即channels。
    # 由于卷积核是（3， 3）, 所以卷积后的尺寸变为（30，30 ）
    # 要保证尺寸不变，则需要设置padding的值为2
    writer.add_images("input", imgs, step)
    #  tensor.Size([64, 6, 30, 30]) --> [xxx, 3, 30, 30](增加batchsize)
    output = torch.reshape(output, (-1, 3, 30, 30))
    writer.add_images("output", output, step)
    step = step + 1 
    
writer.close()
```

可以看到坐标Project页面的logs文件夹里会生成一个新的log文件，然后在Terminal中输入`tensorboard --logdir=logs`,点击显示的端口，可以在显示的页面中看到图片

![image-20251026204739839](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062101314.png)

![image-20251026204756005](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062101714.png)

batchsize从64变为128



输出尺寸计算公式

![image-20251026205225766](https://typora3.oss-cn-shanghai.aliyuncs.com/202511062101994.png)